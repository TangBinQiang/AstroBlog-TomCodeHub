---
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";
import { toolCategories } from "../data/tools";
---

<Layout title={`工具集 | ${SITE.title}`}>
  <Header />
  <Main pageTitle="工具集" pageDesc="实用工具导航">
    <div class="space-y-8">
      {toolCategories.map((category, index) => {
        const uniqueCategoryId = `${category.title}-${index}`;
        return (
        <div class="space-y-6" data-category-container={uniqueCategoryId}>
          <h2 class="text-xl font-bold mb-4">{category.title}</h2>
          {/* 二级目录导航 */}
          {category.subCategories && category.subCategories.length > 0 && (
            <nav class="flex flex-wrap gap-2 mb-4" aria-label={`${category.title}分类导航`}>
              <button 
                class="subcategory-btn px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-transparent text-foreground transition-all duration-200 hover:bg-muted/50"
                data-category={uniqueCategoryId}
                data-subcategory="all"
                aria-label={`查看全部${category.title}工具`}
              >
                全部
              </button>
              {category.subCategories.map(subCategory => (
                <button 
                  class="subcategory-btn px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-transparent text-foreground transition-all duration-200 hover:bg-muted/50"
                  data-category={uniqueCategoryId}
                  data-subcategory={subCategory}
                  aria-label={`查看${subCategory}工具`}
                >
                  {subCategory}
                </button>
              ))}
            </nav>
          )}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 tool-grid" data-category={uniqueCategoryId}>
            {category.tools.map(tool => (
              <a 
                href={tool.url} 
                target="_blank" 
                rel="noopener noreferrer"
                class="relative border border-border bg-muted/30 p-4 rounded-lg transition-transform hover:scale-105 hover:bg-muted/50 tool-item"
                data-subcategory={tool.subCategory || 'all'}
                data-category={uniqueCategoryId}
              >
                {tool.recommended && (
                  <div class="absolute top-0 right-0">
                    <span class="inline-flex items-center gap-1 bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xs font-semibold px-2.5 py-1 rounded-bl-lg rounded-tr-lg shadow-md">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      推荐
                    </span>
                  </div>
                )}
                <div class="flex items-center gap-2 mb-2">
                  {tool.icon && tool.icon.src && <img src={tool.icon.src} alt="" class="w-8 h-8" />}
                  <div class="font-bold text-lg text-foreground">{tool.name}</div>
                </div>
                <div class="text-sm text-foreground/80">{tool.description}</div>
              </a>
            ))}
          </div>
        </div>
      )})}
    </div>
  </Main>
  <Footer />
</Layout>

<style>
  a {
    text-decoration: none;
    color: inherit;
  }
</style>

<script is:inline>
      // 二级目录导航功能 - 确保页面加载完成后执行
      function initSubcategoryFilter() {
        const buttons = document.querySelectorAll('.subcategory-btn');
        if (buttons.length === 0) return;
        
        console.log('初始化子类别筛选功能');
        
        // 获取所有唯一的分类
        const categories = [...new Set(Array.from(buttons).map(btn => btn.dataset.category))];
        
        categories.forEach(function(category) {
          const categoryButtons = Array.from(document.querySelectorAll('.subcategory-btn[data-category="' + category + '"]'));
          const items = Array.from(document.querySelectorAll('.tool-grid[data-category="' + category + '"] .tool-item'));
          
          function setActive(activeBtn) {
            categoryButtons.forEach(function(btn) {
              const isActive = btn === activeBtn;
              btn.classList.toggle('bg-muted', isActive);
              btn.classList.toggle('border-muted-foreground', isActive);
              btn.classList.toggle('bg-transparent', !isActive);
              btn.classList.toggle('border-border', !isActive);
            });
          }
          
          function filterItems(sub) {
            items.forEach(function(element) {
              const itemSub = element.dataset.subcategory || 'all';
              element.style.display = (sub === 'all' || itemSub === sub) ? '' : 'none';
            });
          }
          
          // 初始化
          const allBtn = categoryButtons.find(function(btn) {
            return btn.dataset.subcategory === 'all';
          });
          
          if (allBtn) {
            setActive(allBtn);
            filterItems('all');
          }
          
          // 绑定事件 - 确保每个分类独立处理
          categoryButtons.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              const btnCategory = btn.dataset.category;
              if (btnCategory === category) {
                setActive(btn);
                filterItems(btn.dataset.subcategory || 'all');
              }
            });
          });
        });
      }
      
      // 多种方式确保初始化
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSubcategoryFilter);
      } else {
        initSubcategoryFilter();
      }
      
      // 处理 Astro 视图转换
      document.addEventListener('astro:page-load', initSubcategoryFilter);
    </script>
