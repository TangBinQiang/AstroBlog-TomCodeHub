---
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";

// 导入图标
import IconTimeline from "../assets/icons/IconTimeline.svg";
import IconRss from "../assets/icons/IconRss.svg";

const timelineEntries = [
  {
    flag: "JP",
    title: "Visit to Japan — Osaka, Kyoto & Tokyo",
    date: "May 2025",
    photos: [
      "https://www.laogou717.com/_next/image?url=%2Fchangelog%2F2024-01-01-%E5%85%A8%E8%81%8C%E5%8D%9A%E4%B8%BB%2FIMG_0499.jpg&w=1920&q=75",
      "https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1549693578-d683be217e58?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1587818542513-c30b853d2d05?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1492571350019-22de08371fd3?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1590559899731-a382839e5549?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1528164344705-47542687000d?w=400&h=300&fit=crop",
      "https://tse1.mm.bing.net/th/id/OIP.U_uj1lJJzLqyAf1WljIAVAHaE2?rs=1&pid=ImgDetMain&o=7&rm=3",
      "https://www.laogou717.com/_next/image?url=%2Fchangelog%2F2024-01-01-%E5%85%A8%E8%81%8C%E5%8D%9A%E4%B8%BB%2FIMG_0499.jpg&w=1920&q=75",
      
     
    ],
  },
  {
    flag: "🚗",
    title: "Fourth car — Opel Mokka (2025 model)",
    date: "April 5, 2025",
  },
  {
    flag: "🇩🇰",
    title: "Visit to Denmark & Sweden — Copenhagen & Malmö",
    date: "November 2024",
    photos: [
      "https://images.unsplash.com/photo-1513622470522-26c3c8a854bc?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1499955085172-a104c9463ece?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1557804506-669a67965ba0?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1605718467992-b8d52e5bcb9d?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1508189860359-777d945909ef?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1576075796033-848c2a5f3696?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1551524164-4d4ec6abb4cb?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1589113469251-14b2d6d0ed4e?w=400&h=300&fit=crop",
    ],
  },
  {
    flag: "🇪🇸",
    title: "Visit to Spain — Begur & Barcelona",
    date: "July 2024",
    photos: [
      "https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1583422409516-2895a77efded?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1564221710304-0b37c8b9d729?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1558642452-9d2a7deb7f62?w=400&h=300&fit=crop",
    ],
  },
  {
    icon: IconRss,
    title: "无业游民 — 继续制作视频",
    date: "2024年",
    description: "当累计投入达到10000小时，那些看似沉默的作品会像中子星物质般突然被\"点亮\"——每克重量都释放出超新星级别的能量。我希望保持这种克制的燃烧，于由一定会送来些许我观察的观众星群。",
    photos: [
      "https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1492619375914-88005aa9e8fb?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1579952363873-27d3bfad9c0d?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1551808525-51a94da548ce?w=400&h=300&fit=crop",
      "https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=400&h=300&fit=crop",
    ],
  },
  {
    icon: IconTimeline,
    title: "域名迁移 — 域名迁移到Cloudflare",
    date: "2024年9月3日",
    description: "最终还是把域名转移到了Cloudflare上 😊",
    photos: ["https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&h=300&fit=crop"],
  },
];

// 照片旋转角度数组
const photoRotations = [-5, 2, -3, 4, 1, -2, 3, -1];
---

<Layout title={`时间线 | ${SITE.title}`}>
  <Header activeNav="timeline" />
  <Main pageTitle="Timeline" pageDesc="Here you can find the major updates and changes to my life.">
    <div class="timeline-container">
      {timelineEntries.map((entry, index) => (
        <div class="timeline-item">
          <div class="timeline-meta">
            {entry.flag && <span class="timeline-flag">{entry.flag}</span>}
            {entry.icon && <img src={entry.icon.src} alt="" class="timeline-icon" />}
            <div class="timeline-info">
              <h3 class="timeline-title">{entry.title}</h3>
              <span class="timeline-date">{entry.date}</span>
            </div>
          </div>

          {entry.description && (
            <p class="timeline-description">{entry.description}</p>
          )}

          {entry.photos && (
            <div class={`photo-stack ${entry.photos.length === 1 ? 'single-photo' : entry.title.includes('视频') ? 'video-stack' : ''}`}>
              {entry.photos.map((photo, photoIndex) => (
                <div 
                  class="photo-item"
                  style={`--rotation: ${photoRotations[photoIndex] || 0}deg; --z-index: ${entry.photos.length - photoIndex};`}
                >
                  <img src={photo} alt={`${entry.title} Photo ${photoIndex + 1}`} />
                </div>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </Main>
  <Footer />

  <div id="fullscreen-modal" class="modal-overlay" style="display: none;">
    <span class="close-button">&times;</span>
    <span class="prev-button">&#10094;</span>
    <img class="modal-content" id="fullscreen-image" />
    <span class="next-button">&#10095;</span>
  </div>
</Layout>

<style>
  .timeline-container {
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .timeline-item {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .timeline-item:last-child {
    border-bottom: none;
  }

  .timeline-item:nth-child(1) { animation-delay: 0.1s; }
  .timeline-item:nth-child(2) { animation-delay: 0.2s; }
  .timeline-item:nth-child(3) { animation-delay: 0.3s; }
  .timeline-item:nth-child(4) { animation-delay: 0.4s; }
  .timeline-item:nth-child(5) { animation-delay: 0.5s; }
  .timeline-item:nth-child(6) { animation-delay: 0.6s; }

  .timeline-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .timeline-flag {
    font-size: 1.5rem;
    line-height: 1;
  }

  .timeline-icon {
    width: 20px;
    height: 20px;
    object-fit: contain;
  }

  .timeline-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .timeline-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-text);
  }

  .timeline-date {
    font-size: 0.875rem;
    color: var(--color-text-light);
    white-space: nowrap;
    margin-left: 1rem;
  }

  .timeline-description {
    margin: 1rem 0 1.5rem 0;
    line-height: 1.6;
    color: var(--color-text);
    font-size: 1rem;
  }

  .photo-stack {
    position: relative;
    height: 200px;
    margin: 1.5rem 0;
    perspective: 1000px;
  }

  .single-photo {
    height: 150px;
  }

  .video-stack {
    height: 180px;
  }

  .photo-item {
    position: absolute;
    width: 150px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.1),
      0 8px 16px rgba(0, 0, 0, 0.1);
    transform: 
      rotate(var(--rotation)) 
      translateZ(0);
    z-index: var(--z-index);
    transition: 
      transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
      box-shadow 0.3s ease,
      z-index 0s;
    cursor: pointer;
    border: 3px solid white;
  }

  .photo-item:nth-child(1) { left: 0; top: 0; }
  .photo-item:nth-child(2) { left: 60px; top: 10px; }
  .photo-item:nth-child(3) { left: 90px; top: 5px; }
  .photo-item:nth-child(4) { left: 120px; top: 15px; }
  .photo-item:nth-child(5) { left: 150px; top: 0; }
  .photo-item:nth-child(6) { left: 180px; top: 20px; }
  .photo-item:nth-child(7) { left: 210px; top: 8px; }
  .photo-item:nth-child(8) { left: 240px; top: 12px; }
  .photo-item:nth-child(9) { left: 270px; top: 0px; }
  .photo-item:nth-child(10) { left: 300px; top: 10px; }
  .photo-item:nth-child(11) { left: 330px; top: 12px; }

  .photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .photo-item:hover {
    transform: 
      rotate(0deg) 
      translateZ(20px) 
      scale(1.1);
    box-shadow: 
      0 8px 25px rgba(0, 0, 0, 0.15),
      0 16px 32px rgba(0, 0, 0, 0.15);
    z-index: 999 !important;
  }

  .photo-stack:hover .photo-item:not(:hover) {
    transform: 
      rotate(var(--rotation)) 
      translateZ(0) 
      scale(0.95);
    opacity: 0.7;
  }

  /* Single photo adjustments */
  .single-photo .photo-item {
    width: 200px;
    height: 120px;
    left: 0;
    top: 0;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .timeline-container {
      padding: 1rem 0.5rem;
    }

    .timeline-item {
      margin-bottom: 3rem;
      padding-left: 0;
    }

    .timeline-title {
      font-size: 1.25rem;
    }

    .photo-stack {
      height: 160px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 1rem;
    }

    .photo-item {
      width: 120px;
      height: 80px;
      position: relative;
      display: inline-block;
      margin-right: 1rem;
      transform: rotate(0deg) !important;
    }

    .photo-item:nth-child(n) {
      left: auto !important;
      top: auto !important;
    }

    .single-photo .photo-item {
      width: 160px;
      height: 100px;
    }

    .photo-stack:hover .photo-item:not(:hover) {
      transform: scale(1);
      opacity: 1;
    }
  }

  @media (max-width: 480px) {
    .timeline-meta {
      gap: 0.75rem;
    }

    .timeline-flag {
      font-size: 1.25rem;
    }

    .timeline-title {
      font-size: 1.125rem;
    }

    .photo-item {
      width: 100px;
      height: 70px;
    }

    .single-photo .photo-item {
      width: 140px;
      height: 90px;
    }
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .modal-overlay.show {
    opacity: 1;
  }

  .modal-content {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .close-button,
  .prev-button,
  .next-button {
    cursor: pointer;
    position: absolute;
    color: white;
    font-size: 2.5rem;
    user-select: none;
    transition: opacity 0.2s ease;
    opacity: 0.7;
  }

  .close-button:hover,
  .prev-button:hover,
  .next-button:hover {
    opacity: 1;
  }

  .close-button {
    top: 15px;
    right: 30px;
    font-size: 3.5rem;
  }

  .prev-button {
    left: 20px;
  }

  .next-button {
    right: 20px;
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const modal = document.getElementById("fullscreen-modal") as HTMLElement;
    const modalImage = document.getElementById("fullscreen-image") as HTMLImageElement;
    const closeButton = document.querySelector(".close-button") as HTMLElement;
    const prevButton = document.querySelector(".prev-button") as HTMLElement;
    const nextButton = document.querySelector(".next-button") as HTMLElement;

    let currentPhotos: string[] = [];
    let currentIndex = 0;

    const photoItems = document.querySelectorAll(".photo-item img");

    photoItems.forEach(item => {
      item.addEventListener("click", e => {
        const target = e.target as HTMLImageElement;
        const photoStack = target.closest(".photo-stack");
        if (!photoStack) return;

        const images = Array.from(photoStack.querySelectorAll("img"));
        currentPhotos = images.map(img => img.src);
        currentIndex = images.findIndex(img => img.src === target.src);

        updateModalImage();
        showModal();
      });
    });

    function updateModalImage() {
      if (currentPhotos.length > 0) {
        modalImage.src = currentPhotos[currentIndex];
      }
      prevButton.style.display = currentPhotos.length > 1 ? "block" : "none";
      nextButton.style.display = currentPhotos.length > 1 ? "block" : "none";
    }

    function showModal() {
      modal.style.display = "flex";
      setTimeout(() => modal.classList.add("show"), 10);
      document.body.style.overflow = "hidden";
    }

    function hideModal() {
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }, 300);
    }

    function showPrevImage() {
      currentIndex = (currentIndex - 1 + currentPhotos.length) % currentPhotos.length;
      updateModalImage();
    }

    function showNextImage() {
      currentIndex = (currentIndex + 1) % currentPhotos.length;
      updateModalImage();
    }

    closeButton.addEventListener("click", hideModal);
    modal.addEventListener("click", e => {
      if (e.target === modal) {
        hideModal();
      }
    });
    prevButton.addEventListener("click", showPrevImage);
    nextButton.addEventListener("click", showNextImage);

    document.addEventListener("keydown", e => {
      if (modal.style.display === "flex") {
        if (e.key === "Escape") {
          hideModal();
        }
        if (e.key === "ArrowLeft") {
          showPrevImage();
        }
        if (e.key === "ArrowRight") {
          showNextImage();
        }
      }
    });
  });
</script>
